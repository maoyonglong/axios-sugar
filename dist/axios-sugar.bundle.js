var AxiosSugar=function(e){"use strict";function i(e){return void 0!==e}var n=function(e){this.isResend=!1,this.resendDelay=1e3,this.resendTimes=3,this.isSave=!1,this.prop="custom",e=e||{};for(var t=0,r=Object.keys(e);t<r.length;t++){var n=r[t];i(n)?this[n]=e[n]:console.error("[axios sugar]: the option "+n+" is not valid.")}},o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function t(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var r,s={STRING:2,BOOLEAN:4,NUMBER:8},a="undefined"!=typeof window;function u(t){return function(e){if(!a&&r.isBuffer(e))return e.length;switch(typeof e){case"string":return e.length*s.STRING;case"boolean":return s.BOOLEAN;case"number":return s.NUMBER;case"object":return Array.isArray(e)?e.map(u(t)).reduce(function(e,t){return e+t},0):function(e,t){if(null==t)return 0;var r=0;for(var n in t){if("object"==typeof t[n]&&null!==t[n]){if(e.has(t[n]))continue;e.add(t[n])}r+=u(e)(n);try{r+=u(e)(t[n])}catch(e){e instanceof RangeError&&(r=0)}}return r}(t,e);default:return 0}}}function f(e){return u(new WeakSet)(e)}a||(r=require("buffer").Buffer);var c=(p.prototype.set=function(e,t){this.data[e]=t},p.prototype.get=function(e){return this.data[e]||null},p.prototype.contains=function(e){return void 0!==this.data[e]},p);function p(){this.data={}}var l,d=(t(h,l=c),h.prototype.set=function(e,t){for(var r,n,o=this.data,i=0,s=Object.entries(o);i<s.length;i++){var a=s[i],u=a[0],c=a[1];r=(new Date).getTime(),n=c.time,r-n>=this.duration&&delete o[u]}f(t)+f(o)>this.limit&&(o=this.data={}),o[e]={data:t,time:(new Date).getTime()}},h.prototype.get=function(e){var t=this.data[e];return t?t.data:null},h);function h(e,t){var r=l.call(this)||this;return r.duration=3e5,r.limit=15728640,i(e)&&(r.duration=e),i(t)&&(r.limit=t),r}var v=(g.prototype.set=function(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("[axios-sugar]: "+e.message)}},g.prototype.get=function(e){var t=localStorage.getItem(e);return null===t?null:JSON.parse(t)},g.prototype.contains=function(e){return null!==this.get(e)},g);function g(){}var m=(y.prototype.push=function(e){return this.stack.push(e)},y.prototype.pop=function(){return this.stack.pop()},y.prototype.contains=function(e){return 0<=this.stack.indexOf(e)},y.prototype.remove=function(e){return this.stack.splice(this.indexOf(e),1)[0]},y.prototype.indexOf=function(e){return this.stack.indexOf(e)},y);function y(){this.stack=[]}var S,b=(t(O,S=m),O.prototype.forEach=function(n){this.stack.forEach(function(e,t,r){n.call(e,e,t,r)})},O);function O(){return null!==S&&S.apply(this,arguments)||this}var x,R=(t(k,x=m),k);function k(){return null!==x&&x.apply(this,arguments)||this}function w(e){return 0<=["post","put","patch"].indexOf(e)?"data":"get"===e?"params":"both"}function j(e){var t,s=e.url,r=e.method;function n(e){var t="";if(/\?/.test(s)){var r=s.split("?");s=r[0],t+=r[1]}if(e)for(var n=0,o=Object.entries(e);n<o.length;n++){var i=o[n];""!==t&&(t+="&"),t+=i[0]+"="+i[1]}return t}function o(e){return i(e)?JSON.stringify(e):""}switch(w(r)){case"params":t=n(e.params);break;case"data":t=o(e.data);break;case"both":t=n(e.params)||o(e.params)}return"method="+r+"&url="+s+"&data="+t}function P(e,t){return void 0===e?t:e}function A(e,i){var s,t=e.axios,a=e.storage,u=e.config,c=e.lifecycle;t.interceptors.request.use(function(e){if(e=function(e,t){if(void 0===t&&(t="custom"),"data"===w(e.method)&&e.data){var r=e.data[t];r&&(e[t]=r,delete e.data[t])}return e}(e,u.prop),i.contains(e))return s={reason:"existed"},Promise.reject(s);var t=e[u.prop],r=u.isSave;if(t&&(r=P(t.isSave,r)),r){var n=a.get(j(e));if(n)return s={reason:"saved",data:n},Promise.reject(s)}var o=c.beforeRequest(e);return o.state?(i.push(e),Promise.resolve(e)):(s={reason:"beforeRequestBreak",message:o.message},Promise.reject(s))},function(e){Promise.reject(e)})}var N=(T.prototype.beforeRequest=function(e){return{state:!0,message:""}},T.prototype.beforeResponse=function(e){return{state:!0,message:""}},T);function T(){}var E=(B.prototype.init=function(){var e,u,c,f,a,p,l;A(this,this.stack),u=(e=this).stack,f=e.axios,a=e.storage,p=e.config,l=e.lifecycle,f.interceptors.response.use(function(e){var t=e.config,r=e.data,n=l.beforeResponse(e);if(!n.state)return c={reason:"beforeResponseBreak",message:n.message},Promise.reject(c);t&&u.remove(t);var o,i=t.custom;if(i&&(o=P(i.isSave,p.isSave)),o){var s=j(t);a.set(s,r)}return Promise.resolve(r)},function(e){var t=e.reason;if(t)return"saved"===t?Promise.resolve(e.data):Promise.reject(e);var r=e.config;if(r){u.remove(r);var n=r[p.prop],o=p.isResend,i=p.resendDelay,s=p.resendTimes,a=0;return n&&(o=P(n.isResend,o),i=P(n.resendDelay,i),s=P(n.resendTimes,s),a=P(n.curResendTimes,0)),o?a<s?new Promise(function(e){setTimeout(function(){return n||(r.custom={}),r.custom.curResendTimes=++a,"string"==typeof r.data&&(r.data=JSON.parse(r.data)),e(f.request(r))},i)}):(c={reason:"resendEnd",message:"Can't get a response."},Promise.reject(c)):Promise.reject(e)}})},B);function B(e,t){var r=this;void 0===t&&(t={}),this.stack=new b,this.config=new n,this.storage=new c,this.lifecycle=new N,this.axios=e,["config","storage","lifecycle"].forEach(function(e){t[e]&&(r[e]=t[e])}),this.init()}var _=new R;return e.AxiosSugarConfig=n,e.AxiosSugarInnerReleaseStorage=d,e.AxiosSugarInnerStorage=c,e.AxiosSugarLifeCycle=N,e.AxiosSugarLocalStorage=v,e.default=function(e,t){if(void 0===t&&(t={}),!_.contains(e))return _.push(e),new E(e,t);console.error("[axios-sugar]: an axios static or instance only can call factory once.")},e}({});
